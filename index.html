<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√ñmer Alƒ±≈üveri≈ü</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#16a34a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="√ñmer Alƒ±≈üveri≈ü" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#98a2b3; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #142043 0%, var(--bg) 55%);
      color:var(--text); min-height:100vh; display:flex; justify-content:center; }
    .wrap{ width:min(980px, 100%); padding:18px; }
    .top{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:10px 0 14px; }
    h1{ margin:0; font-size:20px; letter-spacing:.2px }
    .badge{ color:var(--muted); font-size:13px }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:14px; box-shadow: 0 12px 40px rgba(0,0,0,.35); }
    .grid{ display:grid; grid-template-columns: 1.2fr .5fr .7fr .7fr; gap:10px; }
    @media (max-width:820px){ .grid{ grid-template-columns: 1fr .45fr; } .grid .cat, .grid .price{ grid-column: 1/-1; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select{ width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20); color:var(--text); outline:none; }
    input::placeholder{ color: rgba(229,231,235,.45) }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{ border:0; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:900;
      background: rgba(255,255,255,.10); color:var(--text); border:1px solid rgba(255,255,255,.10); }
    button.primary{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
    button.warn{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.35); }
    button.danger{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35); }
    button:disabled{ opacity:.45; cursor:not-allowed }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }
    .totals{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px; border:1px solid rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .totals .big{ font-size:16px; font-weight:950; }
    .mini{ font-size:12px; color: rgba(229,231,235,.8); }
    .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:14px 0 10px;}
    .toolbar .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{ display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); }
    .item .main{ display:flex; gap:10px; align-items:center; min-width:0; flex:1; }
    .item input[type=checkbox]{ width:18px; height:18px; }
    .name{ min-width:0; }
    .name .t{ font-size:15px; font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .name .s{ font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .strike .t{ text-decoration: line-through; color: rgba(229,231,235,.55); }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      color: rgba(229,231,235,.85); background: rgba(255,255,255,.06); white-space:nowrap; }
    .footer{ margin-top:14px; font-size:12px; color:var(--muted); text-align:center; }

    /* Scanner modal */
    .modal{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal .panel{ width:min(860px, 100%); background: rgba(10,14,24,.98); border:1px solid rgba(255,255,255,.12);
      border-radius:16px; overflow:hidden; box-shadow: 0 18px 55px rgba(0,0,0,.5); }
    .modal .bar{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(255,255,255,.10); }
    .modal .bar .title{ font-weight:950; display:flex; gap:10px; align-items:center; }
    .modal .bar .title img{ width:28px; height:28px; border-radius:8px; }
    .videoWrap{ position:relative; background:#000; }
    video{ width:100%; height:auto; display:block; }
    .reticle{ position:absolute; inset:12%; border:2px solid rgba(34,197,94,.9); border-radius:14px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,.28) inset; pointer-events:none; }
    .scanInfo{ padding:10px 12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(0,0,0,.65); color: white; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.15); display:none; max-width: min(92vw, 560px); }

    /* Splash overlay */
    .splash{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 20% 0%, #142043 0%, #0b1220 60%); z-index:9999; }
    .splash .box{ display:flex; flex-direction:column; align-items:center; gap:14px; padding:18px 20px; border-radius:18px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); box-shadow: 0 18px 55px rgba(0,0,0,.45); }
    .splash img{ width:96px; height:96px; border-radius:22px; }
    .splash .name{ font-weight:950; font-size:18px; letter-spacing:.2px; }
    .splash .sub{ color: rgba(229,231,235,.75); font-size:12px; }
  </style>
</head>
<body>
  <div class="splash" id="splash">
    <div class="box">
      <img src="icons/icon-512.png" alt="√ñmer Alƒ±≈üveri≈ü" />
      <div class="name">√ñmer Alƒ±≈üveri≈ü</div>
      <div class="sub">Hazƒ±rlanƒ±yor‚Ä¶</div>
    </div>
  </div>

  <div class="wrap">
    <div class="top">
      <div>
        <h1>üõí √ñmer Alƒ±≈üveri≈ü</h1>
        <div class="badge" id="stats">Y√ºkleniyor‚Ä¶</div>
      </div>
      <div class="badge">APK i√ßin: PWABuilder ‚Üí Android</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="name">√úr√ºn</label>
          <input id="name" placeholder="√ñrn: S√ºt" autocomplete="off" />
        </div>
        <div>
          <label for="qty">Adet</label>
          <input id="qty" inputmode="numeric" pattern="[0-9]*" value="1" />
        </div>
        <div class="cat">
          <label for="cat">Kategori</label>
          <select id="cat">
            <option value="Genel">Genel</option>
            <option value="Market">Market</option>
            <option value="Manav">Manav</option>
            <option value="Kasap">Kasap</option>
            <option value="Temizlik">Temizlik</option>
            <option value="Kƒ±rtasiye">Kƒ±rtasiye</option>
            <option value="Diƒüer">Diƒüer</option>
          </select>
        </div>
        <div class="price">
          <label for="price">Birim fiyat (‚Ç∫)</label>
          <input id="price" inputmode="decimal" placeholder="√ñrn: 35,50" />
        </div>
      </div>

      <div class="row">
        <button class="primary" id="addBtn">+ Ekle</button>
        <button id="quickBtn">Hƒ±zlƒ± ekle</button>
        <button class="primary" id="scanBtn">üì∑ Barkod okut</button>
        <button id="barcodeManageBtn">üè∑Ô∏è Barkodlar</button>
        <button class="warn" id="shareBtn" disabled>Payla≈ü</button>
        <button class="danger" id="clearDoneBtn" disabled>Bitenleri sil</button>
        <button class="danger" id="resetBtn">Listeyi sƒ±fƒ±rla</button>
      </div>

      <div class="hr"></div>

      <div class="totals">
        <div>
          <div class="big" id="totalText">Toplam: ‚Ç∫0</div>
          <div class="mini" id="totalDetail">Kalan: ‚Ç∫0 ‚Ä¢ Biten: ‚Ç∫0</div>
        </div>
        <div class="mini" id="countInfo"></div>
      </div>

      <div class="toolbar">
        <div class="left">
          <input id="search" placeholder="Ara (√∂rn: s√ºt)" style="min-width:220px" />
          <select id="filterCat" style="min-width:160px">
            <option value="ALL">T√ºm kategoriler</option>
          </select>
          <select id="filterStatus" style="min-width:160px">
            <option value="ALL">T√ºm√º</option>
            <option value="OPEN">Kalanlar</option>
            <option value="DONE">Bitenler</option>
          </select>
        </div>
        <div class="right">
          <button class="danger" id="deleteByCatBtn" disabled>Kategoriyi temizle</button>
        </div>
      </div>

      <div class="list" id="list"></div>
      <div class="footer">Barkod i√ßin HTTPS + kamera izni gerekir. √úr√ºn adƒ± bulunamazsa sorar.</div>
    </div>
  </div>

  <div class="modal" id="scannerModal" aria-hidden="true">
    <div class="panel">
      <div class="bar">
        <div class="title"><img src="icons/icon-192.png" alt="" /> Barkod Okut</div>
        <button class="danger" id="closeScanBtn">Kapat</button>
      </div>
      <div class="videoWrap">
        <video id="video" autoplay playsinline></video>
        <div class="reticle"></div>
      </div>
      <div class="scanInfo">
        <div class="mini" id="scanStatus">Kamera a√ßƒ±lƒ±yor‚Ä¶</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="flipCamBtn">Kamera deƒüi≈ütir</button>
          <button class="warn" id="manualBtn">Kodu elle gir</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Barkod Y√∂netim Modal -->
  <div class="modal" id="barcodeModal" aria-hidden="true">
    <div class="panel">
      <div class="bar">
        <div class="title"><img src="icons/icon-192.png" alt="" /> Kayƒ±tlƒ± Barkodlar</div>
        <button class="danger" id="closeBarcodeBtn">Kapat</button>
      </div>

      <div style="padding:12px;">
        <input id="barcodeSearch" placeholder="Barkod veya √ºr√ºn adƒ±na g√∂re ara" style="width:100%; margin-bottom:10px;" />
        <div id="barcodeList" class="list"></div>
        <div class="mini" style="margin-top:10px; color:rgba(229,231,235,.7);">
          ƒ∞pucu: ‚ÄúFiyat deƒüi≈ütir‚Äù ile fiyatƒ± g√ºncelle, ‚ÄúUnut‚Äù ile barkodu tamamen sil.
        </div>
      </div>
    </div>
  </div>


  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser/umd/zxing-browser.min.js"></script>

<script>
  const $ = (id) => document.getElementById(id);

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }

  window.addEventListener("load", () => {
    const sp = $("splash");
    setTimeout(() => { if(sp) sp.style.display = "none"; }, 450);
  });

  const LIST_KEY = "omer_shopping_tr_v1";
  const BARCODE_MAP_KEY = "omer_barcode_tr_v1";
  let items = [];
  let barcodeMap = {};

  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 2300);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function clampQty(v){
    const n = parseInt(v, 10);
    if (Number.isNaN(n)) return 1;
    return Math.max(1, Math.min(999, n));
  }
  function toNumberPrice(v){
    const s = String(v ?? "").trim().replace(",", ".");
    const n = parseFloat(s);
    if (Number.isNaN(n)) return null;
    return Math.max(0, Math.min(999999, n));
  }
  function money(n){
    const val = Math.round((n + Number.EPSILON) * 100) / 100;
    return "‚Ç∫" + val.toLocaleString("tr-TR", { minimumFractionDigits: val % 1 ? 2 : 0, maximumFractionDigits: 2 });
  }

  function load(){
    try{
      const raw = localStorage.getItem(LIST_KEY);
      items = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(items)) items = [];
    }catch{ items = []; }
    try{
      const raw2 = localStorage.getItem(BARCODE_MAP_KEY);
      barcodeMap = raw2 ? JSON.parse(raw2) : {};
      if (barcodeMap == null || typeof barcodeMap !== "object") barcodeMap = {};
    }catch{ barcodeMap = {}; }
  }
  function save(){
    localStorage.setItem(LIST_KEY, JSON.stringify(items));
    localStorage.setItem(BARCODE_MAP_KEY, JSON.stringify(barcodeMap));
  }

  function addItem(name, qty, cat, price){
    const n = String(name ?? "").trim();
    if(!n) return;
    items.unshift({ id: uid(), name: n, qty: clampQty(qty ?? 1), cat: cat || "Genel", price: (price == null ? null : toNumberPrice(price)),
      done:false, createdAt: Date.now() });
    save(); render();
  }

  function addFromInputs(){
    const name = $("name").value.trim();
    const qty = $("qty").value.trim();
    const cat = $("cat").value;
    const price = toNumberPrice($("price").value);
    if(!name) return;
    addItem(name, qty, cat, price);
    $("name").value = ""; $("qty").value = "1"; $("price").value = "";
  }

  function toggle(id){ const i = items.findIndex(x => x.id === id); if(i<0) return; items[i].done=!items[i].done; save(); render(); }
  function del(id){ items = items.filter(x => x.id !== id); save(); render(); }
  function clearDone(){ items = items.filter(x => !x.done); save(); render(); }
  function deleteBySelectedCat(){
    const cat = $("filterCat").value;
    if(cat === "ALL") return;
    if(!confirm(`"${cat}" kategorisindeki t√ºm √ºr√ºnler silinsin mi?`)) return;
    items = items.filter(x => x.cat !== cat); save(); render();
  }
  function resetAll(){ if(!confirm("Liste tamamen sƒ±fƒ±rlansƒ±n mƒ±?")) return; items=[]; save(); render(); }

  function buildCatFilter(){
    const select = $("filterCat");
    const current = select.value || "ALL";
    const cats = Array.from(new Set(items.map(x => x.cat))).sort((a,b)=>a.localeCompare(b,"tr"));

    select.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL"; optAll.textContent = "T√ºm kategoriler"; select.appendChild(optAll);
    for(const c of cats){ const opt=document.createElement("option"); opt.value=c; opt.textContent=c; select.appendChild(opt); }
    select.value = cats.includes(current) ? current : "ALL";
    $("deleteByCatBtn").disabled = (select.value === "ALL") || cats.length === 0;
  }

  function getFiltered(){
    const q = $("search").value.trim().toLowerCase();
    const cat = $("filterCat").value;
    const status = $("filterStatus").value;
    return items.filter(it => {
      if (q && !it.name.toLowerCase().includes(q)) return false;
      if (cat !== "ALL" && it.cat !== cat) return false;
      if (status === "OPEN" && it.done) return false;
      if (status === "DONE" && !it.done) return false;
      return true;
    });
  }

  function calcTotals(){
    let totalAll=0,totalOpen=0,totalDone=0;
    for(const it of items){
      const line = (it.price == null ? 0 : it.price * it.qty);
      totalAll += line;
      if(it.done) totalDone += line; else totalOpen += line;
    }
    return { totalAll, totalOpen, totalDone };
  }

  function shareList(){
    const remaining = items.filter(x => !x.done);
    if(remaining.length === 0){ toast("Payla≈üacak kalan √ºr√ºn yok."); return; }
    const lines = remaining.map((it,i)=>{
      const priceTxt = it.price == null ? "" : ` ‚Ä¢ ${money(it.price)} x ${it.qty} = ${money(it.price*it.qty)}`;
      return `${i+1}) ${it.name} (Adet: ${it.qty}, ${it.cat})${priceTxt}`;
    });
    const totals = calcTotals();
    const text = `üõí √ñmer Alƒ±≈üveri≈ü Listesi
${lines.join("\n")}

Toplam (kalan): ${money(totals.totalOpen)}
`;
    if (navigator.share) navigator.share({ title: "√ñmer Alƒ±≈üveri≈ü", text }).catch(()=>{});
    else navigator.clipboard?.writeText(text).then(()=>toast("Liste kopyalandƒ±. WhatsApp'a yapƒ±≈ütƒ±rabilirsin.")).catch(()=>prompt("Kopyalamak i√ßin:", text));
  }

  async function lookupProductTR(code){
    const url = `https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(code)}.json?fields=product_name,product_name_tr,brands,quantity`;
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) return null;
      const data = await res.json();
      const p = data && data.product ? data.product : null;
      if(!p) return null;
      const nameTr = (p.product_name_tr || "").trim();
      const name = (nameTr || (p.product_name || "")).trim();
      if(!name) return null;
      const brands = (p.brands || "").trim();
      const qty = (p.quantity || "").trim();
      return { name: [name, brands ? `(${brands})` : "", qty ? `‚Ä¢ ${qty}` : ""].filter(Boolean).join(" ") };
    }catch{ return null; }
  }

  // --- Scanner ---
  let stream=null, detector=null, scanning=false, facingMode="environment", zxControls=null;

  function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
  function closeScanner(){
    scanning=false;
    if (zxControls && zxControls.stop) { try{ zxControls.stop(); }catch{} zxControls=null; }
    stopStream();
    $("video").srcObject=null;
    $("scannerModal").style.display="none";
    $("scannerModal").setAttribute("aria-hidden","true");
  }

  async function onBarcodeFound(code){
    scanning=false;
    const mapped = barcodeMap[code];
    if(mapped && mapped.name){
      const p = (mapped.price == null) ? null : Number(mapped.price);
      const priceText = (p == null || Number.isNaN(p)) ? "Fiyat yok" : money(p);
      $("scanStatus").textContent = `Bulundu: ${mapped.name} ‚Ä¢ ${priceText}`;
      toast(`Bulundu: ${mapped.name} ‚Ä¢ ${priceText}`);
      addItem(mapped.name, 1, mapped.cat || $("cat").value, p);
      closeScanner(); return;
    }

    $("scanStatus").textContent = `√úr√ºn aranƒ±yor‚Ä¶ (${code})`;
    const found = await lookupProductTR(code);

    let name = found && found.name ? found.name : "";
    if(!name) name = prompt(`Barkod: ${code}\n√úr√ºn adƒ± bulunamadƒ±. √úr√ºn adƒ± yaz:`, "") || "";
    else name = prompt(`Barkod: ${code}\n√úr√ºn bulundu:\n${name}\n\nDeƒüi≈ütirmek istersen d√ºzenle, deƒüilse OK:`, name) || name;

    name = (name || "").trim();
    if(!name){ toast("√úr√ºn adƒ± girilmedi."); closeScanner(); return; }

    const priceStr = prompt(`"${name}" i√ßin birim fiyat (‚Ç∫) yaz (bo≈ü bƒ±rakabilirsin):`, "");
    const priceVal = (priceStr == null || priceStr.trim()==="") ? null : toNumberPrice(priceStr);
    const cat = $("cat").value;

    barcodeMap[code] = { name, cat, price: priceVal };
    save();

    toast(`Kaydedildi: ${name} ‚Ä¢ ${(priceVal==null?"Fiyat yok":money(priceVal))}`);
    addItem(name, 1, cat, priceVal);
    closeScanner();
  }

  async function startScanner(){
    $("scanStatus").textContent="Kamera a√ßƒ±lƒ±yor‚Ä¶";
    const video = $("video");

    if ("BarcodeDetector" in window) {
      detector = new BarcodeDetector({ formats: ["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code","itf"] });
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:facingMode } }, audio:false });
      video.srcObject=stream; await video.play();
      scanning=true; $("scanStatus").textContent="Barkodu √ßer√ßeveye getir‚Ä¶";
      (async function loop(){
        if(!scanning) return;
        try{
          const barcodes = await detector.detect(video);
          if(barcodes && barcodes.length){
            const code = barcodes[0].rawValue || "";
            if(code){ await onBarcodeFound(code); return; }
          }
        }catch{}
        requestAnimationFrame(loop);
      })();
      return;
    }

    if (window.ZXingBrowser && window.ZXingBrowser.BrowserMultiFormatReader) {
      const reader = new ZXingBrowser.BrowserMultiFormatReader();
      scanning=true; $("scanStatus").textContent="Barkodu √ßer√ßeveye getir‚Ä¶ (ZXing)";
      zxControls = await reader.decodeFromConstraints(
        { video:{ facingMode:{ ideal:facingMode } }, audio:false },
        video,
        async (result) => {
          if(!scanning) return;
          if(result && result.getText){
            const code = result.getText();
            if(code){
              try{ zxControls?.stop?.(); }catch{}
              zxControls=null;
              await onBarcodeFound(code);
            }
          }
        }
      );
      return;
    }

    toast("Barkod okuma desteklenmiyor. Chrome g√ºncelle.");
    closeScanner();
  }

  function openScanner(){
    $("scannerModal").style.display="flex";
    $("scannerModal").setAttribute("aria-hidden","false");
    startScanner().catch(()=>{ toast("Kamera a√ßƒ±lamadƒ±. HTTPS + izin gerekli olabilir."); closeScanner(); });
  }

  function flipCamera(){
    facingMode = (facingMode==="environment") ? "user" : "environment";
    scanning=false;
    if (zxControls && zxControls.stop) { try{ zxControls.stop(); }catch{} zxControls=null; }
    stopStream();
    startScanner().catch(()=>{ toast("Kamera deƒüi≈ütirilemedi."); closeScanner(); });
  }

  function manualBarcode(){
    const code = (prompt("Barkod numarasƒ±nƒ± yaz:", "") || "").trim();
    if(!code) return;
    onBarcodeFound(code);
  }

  function render(){
    buildCatFilter();
    const filtered = getFiltered();
    const list = $("list");
    list.innerHTML = "";

    const remainingCount = items.filter(x => !x.done).length;
    const doneCount = items.filter(x => x.done).length;

    $("stats").textContent = `Toplam: ${items.length} ‚Ä¢ Kalan: ${remainingCount} ‚Ä¢ Biten: ${doneCount}`;
    $("countInfo").textContent = `G√∂r√ºnen: ${filtered.length}`;
    $("clearDoneBtn").disabled = doneCount === 0;
    $("shareBtn").disabled = remainingCount === 0;

    const { totalAll, totalOpen, totalDone } = calcTotals();
    $("totalText").textContent = `Toplam: ${money(totalAll)}`;
    $("totalDetail").textContent = `Kalan: ${money(totalOpen)} ‚Ä¢ Biten: ${money(totalDone)}`;

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="badge">Liste bo≈ü veya filtreye uyan √ºr√ºn yok.</div>`;
      list.appendChild(empty);
      return;
    }

    for(const it of filtered){
      const lineTotal = (it.price == null) ? null : it.price * it.qty;
      const pricePart = (it.price == null) ? `Adet: ${it.qty}` : `Adet: ${it.qty} ‚Ä¢ Birim: ${money(it.price)} ‚Ä¢ Satƒ±r: ${money(lineTotal)}`;

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="main ${it.done ? "strike" : ""}">
          <input type="checkbox" ${it.done ? "checked" : ""} aria-label="tamamlandƒ±" />
          <div class="name">
            <div class="t">${escapeHtml(it.name)}</div>
            <div class="s"><span>${escapeHtml(pricePart)}</span></div>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="chip">${escapeHtml(it.cat)}</span>
          <button class="danger" title="Sil">Sil</button>
        </div>
      `;

      row.querySelector('input[type="checkbox"]').addEventListener("change", () => toggle(it.id));
      row.querySelector("button.danger").addEventListener("click", () => del(it.id));
      row.querySelector(".main").addEventListener("click", (e) => { if(e.target.tagName.toLowerCase()==="input") return; toggle(it.id); });

      list.appendChild(row);
    }
  }

  $("addBtn").addEventListener("click", addFromInputs);
  $("quickBtn").addEventListener("click", () => { addFromInputs(); $("name").focus(); });
  $("scanBtn").addEventListener("click", openScanner);
  $("shareBtn").addEventListener("click", shareList);
  $("clearDoneBtn").addEventListener("click", clearDone);
  $("resetBtn").addEventListener("click", resetAll);
  $("deleteByCatBtn").addEventListener("click", deleteBySelectedCat);

  $("name").addEventListener("keydown", (e) => { if(e.key === "Enter") addFromInputs(); });

  ["search","filterCat","filterStatus"].forEach(id => {
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  
  // --- Barkod Y√∂netimi (Fiyat deƒüi≈ütir / Unut) ---
  function openBarcodeManager(){
    $("barcodeModal").style.display = "flex";
    $("barcodeModal").setAttribute("aria-hidden", "false");
    $("barcodeSearch").value = "";
    renderBarcodeManager();
  }

  function closeBarcodeManager(){
    $("barcodeModal").style.display = "none";
    $("barcodeModal").setAttribute("aria-hidden", "true");
  }

  function renderBarcodeManager(){
    const q = ($("barcodeSearch").value || "").trim().toLowerCase();
    const listEl = $("barcodeList");
    listEl.innerHTML = "";

    const entries = Object.entries(barcodeMap || {})
      .map(([code, obj]) => ({ code, ...(obj || {}) }))
      .filter(x => x.code && x.name);

    const filtered = entries.filter(x => {
      if(!q) return true;
      return x.code.toLowerCase().includes(q) || (x.name || "").toLowerCase().includes(q);
    });

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="badge">Kayƒ±tlƒ± barkod yok.</div>`;
      listEl.appendChild(empty);
      return;
    }

    filtered.reverse();

    for(const it of filtered){
      const priceText = (it.price == null || Number.isNaN(Number(it.price)))
        ? "Fiyat yok"
        : money(Number(it.price));

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="main">
          <div class="name">
            <div class="t">${escapeHtml(it.name)}</div>
            <div class="s">
              <span class="chip">Barkod: ${escapeHtml(it.code)}</span>
              <span class="chip">${escapeHtml(it.cat || "Genel")}</span>
              <span class="chip">${escapeHtml(priceText)}</span>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="warn" data-action="edit" data-code="${escapeHtml(it.code)}">Fiyat deƒüi≈ütir</button>
          <button class="danger" data-action="forget" data-code="${escapeHtml(it.code)}">Unut</button>
        </div>
      `;

      row.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const code = btn.getAttribute("data-code");
          const action = btn.getAttribute("data-action");
          if(action === "edit") editBarcodePrice(code);
          if(action === "forget") forgetBarcode(code);
        });
      });

      listEl.appendChild(row);
    }
  }

  function editBarcodePrice(code){
    const entry = barcodeMap[code];
    if(!entry) return;

    const current = (entry.price == null) ? "" : String(entry.price).replace(".", ",");
    const next = prompt(`"${entry.name}" i√ßin yeni birim fiyat (‚Ç∫):`, current);
    if(next === null) return;

    const val = (next.trim() === "") ? null : toNumberPrice(next);
    barcodeMap[code].price = val;
    save();
    renderBarcodeManager();
    toast("Fiyat g√ºncellendi.");
  }

  function forgetBarcode(code){
    const entry = barcodeMap[code];
    if(!entry) return;
    if(!confirm(`Bu barkodu unutayƒ±m mƒ±?\n${entry.name}\n(${code})`)) return;

    delete barcodeMap[code];
    save();
    renderBarcodeManager();
    toast("Barkod silindi.");
  }


$("closeScanBtn").addEventListener("click", closeScanner);
  $("manualBtn").addEventListener("click", manualBarcode);
  $("flipCamBtn").addEventListener("click", flipCamera);

  $("barcodeManageBtn").addEventListener("click", openBarcodeManager);
  $("closeBarcodeBtn").addEventListener("click", closeBarcodeManager);
  $("barcodeSearch").addEventListener("input", renderBarcodeManager);


  load();
  render();
</script>
</body>
</html>
